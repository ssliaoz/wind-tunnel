# 智慧风洞管理系统综合架构设计

## 1. 系统概述

智慧风洞管理系统是一个集成化的管理平台，旨在对风洞试验的全生命周期、设备资产、安全风险、知识库及系统基础进行数字化管理。系统核心功能围绕试验流程、设备运维与数据分析展开。

针对风洞试验数据实时监测需求，通过 CWT1 PC、CWT2 PC、CWT3 PC、AAWT PC、公共动力系统PC接口，获取系统数据内容，实现秒级数据同步处理。

## 2. 整体技术架构

### 2.1 总体架构

系统采用前后端分离的微服务架构，基于云原生设计理念，具备高可用性、高可扩展性和高安全性。

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端展示层     │    │   API网关       │    │   微服务层      │
│                 │    │                 │    │                 │
│  Vue.js/React   │◄──►│   Nginx/Kong    │◄──►│  试验管理服务    │
│  Element/Ant    │    │                 │    │                 │
│  移动端/H5      │    │                 │    │  设备管理服务    │
│  大屏展示       │    │                 │    │                 │
│                 │    │                 │    │  安全管理服务    │
└─────────────────┘    └─────────────────┘    │                 │
                                            │  知识库服务      │
┌─────────────────┐    ┌─────────────────┐    │                 │
│   数据存储层     │    │   消息中间件     │    │  系统管理服务    │
│                 │    │                 │    │                 │
│   MySQL         │    │   RabbitMQ      │    └─────────────────┘
│   MongoDB       │    │   Redis         │
│   Redis         │    │   Kafka         │    ┌─────────────────┐
└─────────────────┘    └─────────────────┘    │   基础设施层     │
                                            │                 │
┌─────────────────┐    ┌─────────────────┐    │  Docker/K8s     │
│   监控运维层     │    │   第三方集成     │    │  Jenkins       │
│                 │    │                 │    │  Prometheus     │
│   Prometheus    │    │   短信服务      │    │  Grafana       │
│   Grafana       │    │   邮件服务      │    │  ELK Stack     │
│   ELK Stack     │    │   TCP/IP接口    │    └─────────────────┘
└─────────────────┘    └─────────────────┘
```

### 2.2 实时数据采集架构

针对实时数据采集的特殊需求，系统还包含专门的实时数据处理架构：

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   CWT1 PC       │    │   数据采集服务   │    │   流处理引擎     │
│   CWT2 PC       │───►│   (Netty)      │───►│   (Flink)       │
│   CWT3 PC       │    │                 │    │                 │
│   AAWT PC       │    │   TCP连接管理    │    │   实时计算      │
│   公共动力系统PC  │    │   数据解析      │    │   窗口计算      │
└─────────────────┘    │   协议处理      │    │   复杂事件处理   │
                        └─────────────────┘    └─────────────────┘
                                                        │
┌─────────────────┐    ┌─────────────────┐             │
│   前端展示      │◄───│   实时推送      │◄────────────┘
│   (WebSocket)   │    │   (WebSocket)   │    ┌─────────────────┐
└─────────────────┘    └─────────────────┘    │   数据存储      │
                                              │   (MongoDB)     │
┌─────────────────┐    ┌─────────────────┐    │                 │
│   缓存层        │◄───│   消息中间件     │───►│   实时数据      │
│   (Redis)       │    │   (Kafka)       │    │   历史数据      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 3. 前端架构

### 3.1 技术选型
- **框架**: Vue.js 3.x + TypeScript 或 React 18 + TypeScript
- **UI组件库**: Element Plus / Ant Design Vue 或 Ant Design
- **状态管理**: Pinia / Vuex 或 Redux / Zustand
- **路由管理**: Vue Router 或 React Router
- **HTTP客户端**: Axios
- **数据可视化**: ECharts / D3.js / Chart.js
- **实时通信**: WebSocket / Socket.io
- **构建工具**: Vite / Webpack
- **UI组件**: 集成日历组件（适配中国日历）、表格、图表、表单等

### 3.2 实时数据展示
- **WebSocket连接**: 实现服务端主动推送最新数据
- **数据可视化**: ECharts图表展示实时数据变化
- **大屏展示**: 为运维人员提供独立大屏幕用于实时数据监控
- **设备分组**: 按设备类型分组展示数据

## 4. 后端架构

### 4.1 技术栈
- **基础框架**: Spring Boot 3.x + Spring Cloud 2022
- **编程语言**: Java 17+
- **微服务治理**: Spring Cloud Gateway, OpenFeign, Nacos/Eureka
- **安全框架**: Spring Security + JWT + OAuth2
- **持久层**: MyBatis Plus / JPA
- **缓存**: Redis 7.x
- **消息队列**: RabbitMQ / Apache Kafka
- **定时任务**: XXL-Job / Quartz
- **API文档**: Swagger / OpenAPI 3.0

### 4.2 微服务拆分
1. **用户认证服务 (Auth Service)**
   - 用户登录/登出
   - JWT令牌管理
   - 单点登录（预留接口）

2. **试验管理服务 (Experiment Service)**
   - 试验申请与审批
   - 试验排期管理
   - 试验数据采集
   - 成本管控
   - 试验报告管理

3. **设备管理服务 (Equipment Service)**
   - 设备信息管理
   - 维护计划管理
   - 维修管理
   - 健康状态监测
   - 校准管理

4. **安全管理服务 (Security Service)**
   - 风险台账管理
   - 隐患排查记录

5. **知识库服务 (Knowledge Service)**
   - 知识上传/更新
   - 知识查询

6. **系统管理服务 (System Service)**
   - 用户管理
   - 权限配置
   - 站内信
   - 操作日志
   - 系统日志
   - 基础参数配置

7. **通知服务 (Notification Service)**
   - 站内信发送
   - 邮件通知
   - 短信通知

8. **数据采集服务 (Data Collection Service)**
   - TCP/IP接口数据采集
   - 实时数据处理
   - 数据验证与清洗

### 4.3 实时数据处理
- **响应式编程模型**: Spring WebFlux + Project Reactor
  - 非阻塞异步处理
  - 高吞吐量
  - 低内存占用
  - 使用Flux/Mono处理数据流

- **高性能队列**: LMAX Disruptor
  - 内存中的高性能数据流转
  - 低延迟、高吞吐量的事件处理

## 5. 数据采集层

### 5.1 TCP/IP连接管理
- **技术选型**: Netty框架
- **优势**: 
  - 异步非阻塞IO模型
  - 高性能、高并发
  - 稳定的长连接管理
- **实现方案**:
  - 为每个PC系统建立独立的TCP连接池
  - 实现连接心跳检测与自动重连
  - 支持连接状态监控

### 5.2 协议解析
- **数据格式统一处理**: 统一解析来自5个PC系统的数据格式
- **协议适配器模式**: 针对不同PC系统的协议差异实现适配器
- **数据校验**: 对接收到的数据进行完整性校验

### 5.3 连接管理策略
- 每个PC系统（CWT1 PC、CWT2 PC、CWT3 PC、AAWT PC、公共动力系统PC）建立独立的连接
- 连接池配置：最小连接数1，最大连接数5
- 连接超时和重试机制

## 6. 消息中间件层

### 6.1 Apache Kafka
- **分区策略**: 按设备类型或PC系统进行分区
- **副本机制**: 确保数据可靠性
- **批处理配置**: 优化网络传输效率
- **数据保留策略**: 配置合理的数据保留时间

### 6.2 消息处理
- 生产者: 数据采集服务发布原始数据
- 消费者: 流处理引擎消费数据进行实时计算
- 消息序列化: 使用Avro或JSON格式

## 7. 流处理引擎

### 7.1 Apache Flink
- **流处理能力**: 支持毫秒级延迟的流处理
- **窗口计算**: 时间窗口、滑动窗口等计算模式
- **状态管理**: 管理计算过程中的中间状态
- **容错机制**: Checkpoint机制确保数据一致性

### 7.2 实时计算逻辑
- 数据聚合计算（如平均值、最大值、最小值）
- 复杂事件处理（CEP）用于故障检测
- 实时数据质量监控

### 7.3 故障预警算法
- 基于规则的异常检测
- 阈值监控与告警
- 趋势分析与预测

## 8. 数据架构

### 8.1 数据库选型
- **关系型数据库**: MySQL 8.0
  - 存储用户信息、组织架构、试验项目、设备台账等结构化数据
  - 支持事务处理，保证数据一致性

- **文档数据库**: MongoDB 6.0
  - 存储实时采集数据、历史数据、日志数据
  - 支持大容量数据存储和高并发读写
  - 数据保留周期可参考10年

- **缓存数据库**: Redis 7.0
  - 缓存热点数据，提高系统响应速度
  - 存储会话信息、权限信息
  - 实现分布式锁

### 8.2 数据存储策略
- 实时数据：MongoDB（支持10年数据保留）
- 试验管理数据：MySQL/MongoDB混合模式
- 文件存储：支持.txt、.csv、.md、.json、.doc、.docx、.pdf等格式，单个文件最大200MB
- 操作日志：MongoDB（支持按时间/类型检索）

### 8.3 MongoDB配置
- **副本集**: 确保数据高可用性
- **分片集群**: 支持大数据量存储
- **TTL索引**: 自动清理过期历史数据（10年保留周期）
- **写关注**: 根据业务需求配置写入确认级别

### 8.4 存储策略
- **实时数据**: 写入MongoDB，使用时间戳索引优化查询
- **历史数据**: 按时间分区存储
- **索引优化**: 针对查询模式创建复合索引

## 9. 缓存层

### 9.1 Redis集群
- **数据缓存**: 存储最新设备数据
- **发布/订阅**: 支持实时数据推送
- **高性能访问**: 毫秒级数据获取

### 9.2 缓存策略
- **缓存更新**: 数据写入MongoDB后同步更新Redis
- **过期策略**: 设置合理的过期时间
- **数据一致性**: 确保缓存与数据库数据一致性

## 10. 实时推送层

### 10.1 WebSocket协议
- **双向通信**: 服务端主动推送最新数据
- **长连接**: 减少连接建立开销
- **心跳机制**: 维护连接状态

### 10.2 推送策略
- **按设备分组推送**: 根据用户权限推送对应设备数据
- **数据压缩**: 减少网络传输量
- **连接管理**: 连接池和负载均衡

### 10.3 备选方案
- Server-Sent Events (SSE): 适用于单向数据推送

## 11. 接口架构

### 11.1 内部服务接口
- RESTful API + JSON
- gRPC（高性能服务间通信）
- 消息队列（异步通信）

### 11.2 外部接口
- TCP/IP接口（用于CWT1 PC、CWT2 PC、CWT3 PC、AAWT PC、公共动力系统PC数据采集）
- HTTP/HTTPS API（第三方系统集成）
- WebSocket（实时数据推送）

## 12. 安全架构

- **身份认证**: JWT + OAuth2
- **权限控制**: 基于RBAC模型的细粒度权限控制（支持到实验室级别）
- **数据加密**: 敏感数据AES加密存储
- **传输安全**: HTTPS + TLS 1.3
- **访问控制**: IP白名单、API限流
- **审计日志**: 完整的操作日志记录

### 12.1 网络安全
- TCP连接加密（TLS/SSL）
- 网络访问控制
- 防止DDoS攻击

### 12.2 数据安全
- 敏感数据加密存储
- 访问权限控制
- 数据传输加密

## 13. 部署架构

### 13.1 容器化部署
- **容器技术**: Docker
- **容器编排**: Kubernetes (K8s)
- **服务网格**: Istio（可选）

### 13.2 CI/CD流水线
- **代码仓库**: Git
- **持续集成**: Jenkins / GitLab CI
- **镜像仓库**: Harbor / Docker Registry
- **自动化部署**: Helm Charts

### 13.3 负载均衡
- **反向代理**: Nginx
- **API网关**: Spring Cloud Gateway / Kong
- **服务发现**: Nacos / Eureka

### 13.4 高可用保障
- **多副本部署**: 关键服务多副本部署
- **健康检查**: 定期健康检查与自动恢复
- **故障转移**: 自动故障转移机制

## 14. 监控架构

- **应用监控**: Prometheus + Grafana
- **日志收集**: ELK Stack (Elasticsearch, Logstash, Kibana)
- **链路追踪**: Jaeger / Zipkin
- **告警系统**: AlertManager
- **健康检查**: Actuator + 自定义健康检查

### 14.1 系统监控
- **Prometheus**: 指标收集与监控
- **监控指标**:
  - 数据采集延迟
  - 处理吞吐量
  - 连接状态
  - 系统资源使用率

### 14.2 应用监控
- **Grafana**: 可视化监控面板
- **日志监控**: 结合ELK Stack进行日志分析
- **链路追踪**: 使用Jaeger进行分布式链路追踪

### 14.3 告警机制
- **延迟告警**: 数据处理延迟超过阈值
- **连接告警**: TCP连接异常
- **数据异常**: 检测到异常数据值

## 15. 性能与扩展性

### 15.1 性能指标
- 支持100用户并发访问
- 页面响应时间 < 2秒
- API响应时间 < 500毫秒
- 数据库查询时间 < 200毫秒
- 数据采集延迟 < 1秒
- 系统支持高并发连接
- 数据处理吞吐量满足实时性要求
- 系统可用性 ≥ 99.9%

### 15.2 扩展性设计
- 微服务架构支持水平扩展
- 数据库读写分离
- Redis集群部署
- 消息队列集群部署

### 15.3 性能优化
- **连接优化**: 
  - TCP连接复用
  - 连接池参数调优
  - 网络缓冲区调优

- **处理优化**: 
  - 批量处理减少网络调用
  - 异步处理提高吞吐量
  - 内存池减少GC压力

- **存储优化**: 
  - 索引优化提高查询性能
  - 数据压缩减少存储空间
  - 读写分离提高并发能力

## 16. 开发与运维规范

### 16.1 开发规范
- 代码规范：遵循阿里巴巴Java开发手册
- Git工作流：Git Flow
- 代码审查：Pull Request机制
- 文档规范：API文档、数据库设计文档

### 16.2 运维规范
- 容器化部署
- 自动化监控告警
- 定期备份策略
- 灰度发布机制

## 17. 核心功能需求实现

### 17.1 实时数据采集需求
- **核心需求**:
  - TCP/IP协议数据采集
  - 多接口（5个PC系统）并发处理
  - 秒级数据同步与处理
  - 实时数据存储（MongoDB）
  - 按设备可视化展示最新数据
  - 故障实时预警与报警

### 17.2 技术指标
- 数据采集延迟 < 1秒
- 系统支持高并发连接
- 数据处理吞吐量满足实时性要求
- 系统可用性 ≥ 99.9%

## 18. 总结

该技术架构采用现代化的实时数据处理技术栈，能够满足智慧风洞管理系统对秒级数据同步处理的需求。通过Netty进行TCP连接管理，Flink进行实时流处理，MongoDB进行数据存储，WebSocket进行实时推送，形成了一套完整的实时数据处理解决方案，具备高并发、低延迟、高可靠性的特点。

系统整体架构采用微服务设计，具备良好的扩展性和维护性，能够满足风洞试验管理、设备管理、安全管理、知识库和系统管理等全方位需求，同时保证了实时数据采集和处理的高性能要求。